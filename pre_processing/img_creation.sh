#!/bin/bash

# This script is made to automatize in a parallelized way the creation of 1D vector png images from apks
# It launches the Python script made available in DexRay's paper (modified to also perform resizing)

dataset_dir="_dataset/sorted_dataset"
destination_dir="_resized_img_128"
img_size=128

export dataset_dir
export destination_dir
export img_size


process_apk() {
    apk=$1 # path to apk
    folder=$(echo "$apk" | grep -oE "(test|train)") # extract if APK belongs to train or test
    label=$(echo "$apk" | grep -oE "(Malware|Goodware)") # extract word Malware or Goodware from path
    destination_folder="$destination_dir/$folder/$label" # Determine dest folder according to type
    mkdir -p "$destination_folder"
    python pre_processing/apk_to_image.py "$apk" "$destination_folder" $img_size # Execute Python script from DexRay's paper
}

export -f process_apk

# Find all the apks and send them to 'parallel', which executes the function process_apk on each file in parallel
# option --bar to display the progress
find "$dataset_dir" -name '*.apk' | parallel --bar process_apk